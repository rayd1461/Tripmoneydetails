<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅費開支紀錄器</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; }
        h1 { color: #333; }
        
        /* 方形圓角框 */
        .trip-container {
            border: 2px solid #add8e6;
            border-radius: 15px;
            background-color: #ffffff;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .trip-header { border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f0f8ff; }

        /* 按鈕樣式 */
        .btn { padding: 8px 16px; cursor: pointer; border-radius: 5px; border: none; transition: 0.3s; margin: 5px 0; }
        .btn-main { background-color: #007bff; color: white; font-size: 16px; }
        .btn-add { background-color: #28a745; color: white; }
        .btn-end { background-color: #dc3545; color: white; float: right; margin-top: 10px; }
        .btn:hover { opacity: 0.8; }

        /* 彈窗/表單樣式 */
        .modal { 
            display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content { 
            background-color: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 400px; 
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; }
        
        .summary-area { margin-top: 15px; font-weight: bold; color: #d9534f; text-align: right; }
    </style>
</head>
<body>

    <h1>我的旅程紀錄</h1>
    <button class="btn btn-main" onclick="openTripModal()">＋ 新增旅程</button>

    <div id="trip-list"></div>

    <div id="tripModal" class="modal">
        <div class="modal-content">
            <h3>登記新旅程</h3>
            <div class="form-group"><label>旅遊目的地</label><input type="text" id="dest"></div>
            <div class="form-group"><label>出發時間</label><input type="date" id="start"></div>
            <div class="form-group"><label>歸來時間</label><input type="date" id="end"></div>
            <div class="form-group"><label>預計總旅費 (TWD)</label><input type="number" id="budget"></div>
            <button class="btn btn-add" onclick="createNewTrip()">生成旅程表</button>
            <button class="btn" onclick="closeModal('tripModal')">取消</button>
        </div>
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h3>增加支出細項</h3>
            <div class="form-group">
                <label>標籤</label>
                <select id="itemTag">
                    <option value="交通">交通</option>
                    <option value="三餐">三餐</option>
                    <option value="飯店">飯店</option>
                    <option value="服裝">服裝</option>
                    <option value="便利商店">便利商店</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="form-group"><label>細項名稱</label><input type="text" id="itemName"></div>
            <div class="form-group"><label>金額 (外幣)</label><input type="number" id="foreignAmt" oninput="calcTWD()"></div>
            <div class="form-group"><label>當天匯率</label><input type="number" step="0.0001" id="rate" oninput="calcTWD()"></div>
            <div class="form-group"><label>折合台幣 (自動計算)</label><input type="number" id="twdAmt" readonly></div>
            <button class="btn btn-add" id="submitItemBtn">OK</button>
            <button class="btn" onclick="closeModal('itemModal')">取消</button>
        </div>
    </div>

    <script>
        let currentTripId = null;

        function openTripModal() { document.getElementById('tripModal').style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function calcTWD() {
            const amt = document.getElementById('foreignAmt').value;
            const rate = document.getElementById('rate').value;
            if(amt && rate) {
                document.getElementById('twdAmt').value = (amt * rate).toFixed(2);
            }
        }

        function createNewTrip() {
            const dest = document.getElementById('dest').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const budget = document.getElementById('budget').value;

            if(!dest || !start || !end) return alert("請填寫完整資訊");

            const tripId = Date.now();
            const tripHtml = `
                <div class="trip-container" id="trip-${tripId}">
                    <div class="trip-header">
                        <h2>${dest} (${start} ~ ${end})</h2>
                        <p>預計預算：NT$ ${budget}</p>
                    </div>
                    <button class="btn btn-add" onclick="openItemModal(${tripId})">＋ 增加細項</button>
                    <table id="table-${tripId}">
                        <thead>
                            <tr>
                                <th>標籤</th>
                                <th>明細條目</th>
                                <th>金額(外幣)</th>
                                <th>匯率</th>
                                <th>台幣價格</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="summary-area" id="summary-${tripId}"></div>
                    <button class="btn btn-end" onclick="endTrip(${tripId})">結束旅程</button>
                    <div style="clear:both;"></div>
                </div>
            `;
            document.getElementById('trip-list').insertAdjacentHTML('afterbegin', tripHtml);
            closeModal('tripModal');
        }

        function openItemModal(tripId) {
            currentTripId = tripId;
            document.getElementById('itemModal').style.display = 'block';
            document.getElementById('submitItemBtn').onclick = function() {
                addItemToTable(tripId);
            };
        }

        function addItemToTable(tripId) {
            const tag = document.getElementById('itemTag').value;
            const name = document.getElementById('itemName').value;
            const fAmt = document.getElementById('foreignAmt').value;
            const rate = document.getElementById('rate').value;
            const tAmt = document.getElementById('twdAmt').value;

            if(!name || !fAmt || !rate) return alert("請填寫支出明細");

            const tbody = document.querySelector(`#table-${tripId} tbody`);
            const row = `<tr>
                <td>${tag}</td>
                <td>${name}</td>
                <td>${fAmt}</td>
                <td>${rate}</td>
                <td class="twd-val">${tAmt}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
            
            // 清空並關閉
            document.getElementById('itemName').value = '';
            document.getElementById('foreignAmt').value = '';
            document.getElementById('rate').value = '';
            document.getElementById('twdAmt').value = '';
            closeModal('itemModal');
        }

        function endTrip(tripId) {
            if(confirm("確定旅程已結束嗎？結算後將統計總花費。")) {
                let total = 0;
                const rows = document.querySelectorAll(`#table-${tripId} .twd-val`);
                rows.forEach(td => total += parseFloat(td.innerText));
                
                // 四捨五入至個位數 (先到十分位再四捨五入本質上就是標準四捨五入)
                const finalTotal = Math.round(total);
                
                document.getElementById(`summary-${tripId}`).innerHTML = `總花費結算：NT$ ${finalTotal}`;
                
                // 隱藏按鈕避免重複操作
                document.querySelector(`#trip-${tripId} .btn-end`).style.display = 'none';
                document.querySelector(`#trip-${tripId} .btn-add`).style.display = 'none';
                alert(`旅程結束！本次總花費為 NT$ ${finalTotal}`);
            }
        }
    </script>
</body>
</html>
