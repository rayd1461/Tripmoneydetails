<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšæ—…è²»ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --main-blue: #add8e6; --dark-blue: #007bff; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f4f8; padding: 20px; line-height: 1.6; }
        
        .trip-container {
            border: 2px solid var(--main-blue);
            border-radius: 15px;
            background-color: #ffffff;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .trip-header { 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }

        .budget-control { margin: 10px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .budget-control input { padding: 5px; width: 120px; }
        .locked-msg { color: #d9534f; font-size: 0.8em; margin-left: 10px; display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #e3f2fd; }

        .btn { padding: 8px 15px; cursor: pointer; border-radius: 5px; border: none; transition: 0.2s; }
        .btn-main { background-color: var(--dark-blue); color: white; margin-bottom: 20px; }
        .btn-add { background-color: #28a745; color: white; margin-top: 10px; }
        .btn-end { background-color: #6c757d; color: white; float: right; margin-top: 15px; }
        
        .collapsed { display: none; } /* ç”¨æ–¼æ”¶åˆ */
        
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 10px; width: 450px; }
    </style>
</head>
<body>

    <h1>ğŸŒ æ—…ç¨‹é–‹æ”¯ç®¡ç†ç³»çµ±</h1>
    <button class="btn btn-main" onclick="openModal('tripModal')">ï¼‹ æ–°å¢æ—…ç¨‹</button>

    <div id="trip-list"></div>

    <div id="tripModal" class="modal">
        <div class="modal-content">
            <h3>ç™»è¨˜æ–°æ—…ç¨‹</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>ç›®çš„åœ°</label><input type="text" id="dest" style="width:100%"></div>
                <div><label>é è¨ˆæ—…è²»(TWD)</label><input type="number" id="budget" style="width:100%"></div>
                <div><label>å‡ºç™¼æ—¥æœŸ</label><input type="date" id="start"></div>
                <div><label>æ­¸ä¾†æ—¥æœŸ</label><input type="date" id="end"></div>
            </div>
            <p style="font-size: 12px; color: #666;">* æ©Ÿç¥¨ã€é£¯åº—ã€æ—…å¹³éšªç­‰è«‹æ–¼ç´°é …ä¸­ç™»è¨˜æˆ–è¨ˆå…¥é ç®—</p>
            <button class="btn btn-add" onclick="saveTrip()">å»ºç«‹æ—…ç¨‹</button>
            <button class="btn" onclick="closeModal('tripModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢æ”¯å‡º</h3>
            <label>åˆ†é¡</label>
            <select id="itemTag" style="width:100%; margin-bottom:10px;">
                <option>äº¤é€š</option><option>ä¸‰é¤</option><option>é£¯åº—</option>
                <option>æœè£</option><option>ä¾¿åˆ©å•†åº—</option><option>å…¶ä»–</option>
            </select>
            <label>æ˜ç´°å…§å®¹</label><input type="text" id="itemName" style="width:100%; margin-bottom:10px;">
            <label>å¤–å¹£é‡‘é¡</label><input type="number" id="fAmt" style="width:100%" oninput="updateTwd()">
            <label>ç•¶å‰åŒ¯ç‡</label><input type="number" id="rate" step="0.01" style="width:100%" oninput="updateTwd()">
            <p>æŠ˜åˆå°å¹£ï¼š<span id="twdDisplay">0</span></p>
            <button class="btn btn-add" onclick="confirmItem()">ç¢ºèªåŠ å…¥</button>
            <button class="btn" onclick="closeModal('itemModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        let trips = JSON.parse(localStorage.getItem('trips')) || [];
        let activeTripId = null;

        // åˆå§‹åŒ–æ¸²æŸ“
        window.onload = renderTrips;

        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function updateTwd() {
            const f = document.getElementById('fAmt').value;
            const r = document.getElementById('rate').value;
            document.getElementById('twdDisplay').innerText = Math.round(f * r);
        }

        // ä¿å­˜æ—…ç¨‹åˆ° LocalStorage
        function saveTrip() {
            const trip = {
                id: Date.now(),
                dest: document.getElementById('dest').value,
                budget: parseFloat(document.getElementById('budget').value),
                start: document.getElementById('start').value,
                end: document.getElementById('end').value,
                items: [],
                isEnded: false
            };
            trips.push(trip);
            localStorage.setItem('trips', JSON.stringify(trips));
            renderTrips();
            closeModal('tripModal');
        }

        function renderTrips() {
            const list = document.getElementById('trip-list');
            list.innerHTML = '';
            const now = new Date();

            trips.forEach(trip => {
                const startDate = new Date(trip.start + "T00:00:00");
                const isLocked = now >= startDate; // åªè¦åˆ°äº†å‡ºç™¼ç•¶å¤© 00:00ï¼Œå°±é–å®šå‰ä¸€å¤©çš„ 23:59:59 é™åˆ¶

                const container = document.createElement('div');
                container.className = 'trip-container';
                container.innerHTML = `
                    <div class="trip-header" onclick="toggleCollapse(${trip.id})">
                        <div>
                            <strong>ğŸ“ ${trip.dest}</strong> 
                            <small>(${trip.start} ~ ${trip.end})</small>
                        </div>
                        <span>${trip.isEnded ? 'âœ… å·²çµæŸ (é»æ“Šå±•é–‹/æ”¶åˆ)' : 'âœˆï¸ é€²è¡Œä¸­'}</span>
                    </div>
                    
                    <div id="content-${trip.id}" class="${trip.isEnded ? 'collapsed' : ''}">
                        <div class="budget-control">
                            é è¨ˆæ—…è²»ï¼š<input type="number" value="${trip.budget}" 
                                ${isLocked ? 'disabled' : ''} 
                                onchange="updateBudget(${trip.id}, this.value)"> TWD
                            ${isLocked ? '<span class="locked-msg" style="display:inline">ğŸ”’ é ç®—å·²é–å®š</span>' : ''}
                        </div>
                        
                        <table id="table-${trip.id}">
                            <thead><tr><th>æ¨™ç±¤</th><th>å…§å®¹</th><th>å¤–å¹£</th><th>åŒ¯ç‡</th><th>å°å¹£</th></tr></thead>
                            <tbody>
                                ${trip.items.map(i => `<tr><td>${i.tag}</td><td>${i.name}</td><td>${i.fAmt}</td><td>${i.rate}</td><td>${i.tAmt}</td></tr>`).join('')}
                            </tbody>
                        </table>

                        ${!trip.isEnded ? `
                            <button class="btn btn-add" onclick="event.stopPropagation(); openItemModal(${trip.id})">ï¼‹ å¢åŠ ç´°é …</button>
                            <button class="btn btn-end" onclick="event.stopPropagation(); endTrip(${trip.id})">çµæŸæ—…ç¨‹</button>
                        ` : `<div style="margin-top:10px; font-weight:bold; color:red; text-align:right;">ç¸½çµç®—é‡‘é¡ï¼šNT$ ${calculateTotal(trip.id)}</div>`}
                    </div>
                `;
                list.appendChild(container);
            });
        }

        function updateBudget(id, val) {
            const trip = trips.find(t => t.id === id);
            trip.budget = parseFloat(val);
            localStorage.setItem('trips', JSON.stringify(trips));
        }

        function toggleCollapse(id) {
            const el = document.getElementById(`content-${id}`);
            el.classList.toggle('collapsed');
        }

        function openItemModal(id) {
            activeTripId = id;
            openModal('itemModal');
        }

        function confirmItem() {
            const trip = trips.find(t => t.id === activeTripId);
            const item = {
                tag: document.getElementById('itemTag').value,
                name: document.getElementById('itemName').value,
                fAmt: document.getElementById('fAmt').value,
                rate: document.getElementById('rate').value,
                tAmt: Math.round(document.getElementById('fAmt').value * document.getElementById('rate').value)
            };
            trip.items.push(item);
            localStorage.setItem('trips', JSON.stringify(trips));
            renderTrips();
            closeModal('itemModal');
        }

        function calculateTotal(id) {
            const trip = trips.find(t => t.id === id);
            return trip.items.reduce((sum, item) => sum + item.tAmt, 0);
        }

        function endTrip(id) {
            if(confirm("ç¢ºå®šçµæŸæ—…ç¨‹ä¸¦çµç®—å—ï¼ŸçµæŸå¾Œå°‡è‡ªå‹•æ”¶åˆã€‚")) {
                const trip = trips.find(t => t.id === id);
                trip.isEnded = true;
                localStorage.setItem('trips', JSON.stringify(trips));
                renderTrips();
            }
        }
    </script>
</body>
</html>
